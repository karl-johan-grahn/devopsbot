<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>DevOpsBot</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="GETTING_STARTED.html"><strong aria-hidden="true">1.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="incidents/incidents.html"><strong aria-hidden="true">2.</strong> Incident management automation</a></li><li class="chapter-item expanded "><a href="SLACK_APP.html"><strong aria-hidden="true">3.</strong> Slack App configuration</a></li><li class="chapter-item expanded "><a href="TRANSLATIONS.html"><strong aria-hidden="true">4.</strong> Translations</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">DevOpsBot</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/karl-johan-grahn/devopsbot" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa comment"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="getting-started"><a class="header" href="#getting-started">Getting started</a></h1>
<h2 id="invite-bot-to-broadcast-channel"><a class="header" href="#invite-bot-to-broadcast-channel">Invite bot to broadcast channel</a></h2>
<p>For security reasons, the Slack API prohibits bots to invite themselves to channels.
The bot therefore needs to be manually invited to the chosen broadcast channel before it can communicate there.
Invite the bot to the broadcast channel by using this command in the channel:</p>
<pre><code class="language-console">/invite devopsbot
</code></pre>
<h2 id="build"><a class="header" href="#build">Build</a></h2>
<p>These instructions assume you are on a Mac.</p>
<p>Make sure you have the latest version of Go installed: <code>brew update &amp;&amp; brew upgrade</code></p>
<p>Install <code>golangci-lint</code> to be able to run <code>make lint</code>: <code>brew install golangci/tap/golangci-lint</code></p>
<p>To build the binary locally:</p>
<pre><code class="language-console">$ make build
</code></pre>
<p>To build the Docker image locally:</p>
<pre><code class="language-console">$ make image.iid
</code></pre>
<h2 id="deployment"><a class="header" href="#deployment">Deployment</a></h2>
<p>The bot can be deployed any preferred way.</p>
<h3 id="kubernetes"><a class="header" href="#kubernetes">Kubernetes</a></h3>
<p>A certificate need to be issued to expose the application over HTTPS, for example via ZeroSSL or Let's Encrypt.</p>
<p>The application need to be made publicly available.</p>
<p>The Kubernetes resources could look like this for example:</p>
<pre><code class="language-yaml">---
# Source: helmchart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: devopsbot-settings
data:
  addr: :3333
  incident.environments: |-
    [
      &quot;Staging&quot;,
      &quot;Production&quot;
    ]
  incident.regions: |-
    [
      &quot;eu-west-1&quot;,
      &quot;us-east-1&quot;
    ]
  server.prometheusNamespace: devopsbot
  tls.addr: :3443
  tls.cert: /var/devopsbot/tls.crt
  tls.key: /var/devopsbot/tls.key
  trace: &quot;false&quot;
  verbose: &quot;false&quot;
---
# Source: helmchart/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: devopsbot
  labels:
    app: devopsbot
spec:
  ports:
      - port: 3333
        targetPort: 3333
        protocol: TCP
        name: &quot;http&quot;
  selector:
    app: devopsbot
---
# Source: helmchart/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: devopsbot
  labels:
    app: devopsbot

spec:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  replicas: 1
  selector:
    matchLabels:
      app: devopsbot
  template:
    metadata:
      labels:
        app: devopsbot
      annotations:
        prometheus.io/scrape: &quot;true&quot;
        prometheus.io/path: &quot;/metrics&quot;
        prometheus.io/port: &quot;3333&quot;
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 25
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - devopsbot
              topologyKey: &quot;kubernetes.io/hostname&quot;
      containers:
        - name: devopsbot
          image: &lt;path_to_image&gt;
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 3333
          resources:
            limits:
              cpu: 900m
              memory: 256Mi
            requests:
              cpu: 600m
              memory: 20Mi
          readinessProbe:
            httpGet:
              path: /ready
              port: 3333
            initialDelaySeconds: 1
            timeoutSeconds: 1
            periodSeconds: 2
            failureThreshold: 300
          livenessProbe:
            httpGet:
              path: /live
              port: 3333
            initialDelaySeconds: 300
            timeoutSeconds: 2
            periodSeconds: 3
            failureThreshold: 2
          env:
            - name: slack.accessToken
              valueFrom:
                secretKeyRef:
                  key: slack.accessToken
                  name: app-secrets
            - name: slack.adminGroupID
              valueFrom:
                secretKeyRef:
                  key: slack.adminGroupID
                  name: app-secrets
            - name: slack.broadcastChannelID
              valueFrom:
                secretKeyRef:
                  key: slack.broadcastChannelID
                  name: app-secrets
            - name: slack.signingSecret
              valueFrom:
                secretKeyRef:
                  key: slack.signingSecret
                  name: app-secrets
            - name: incidentDocTemplateURL
              valueFrom:
                secretKeyRef:
                  key: incidentDocTemplateURL
                  name: app-secrets
            - name: server.prometheusNamespace
              valueFrom:
                configMapKeyRef:
                  key: server.prometheusNamespace
                  name: devopsbot-settings
            - name: incident.environments
              valueFrom:
                configMapKeyRef:
                  key: incident.environments
                  name: devopsbot-settings
            - name: incident.regions
              valueFrom:
                configMapKeyRef:
                  key: incident.regions
                  name: devopsbot-settings
            - name: addr
              valueFrom:
                configMapKeyRef:
                  key: addr
                  name: devopsbot-settings
            - name: tls.addr
              valueFrom:
                configMapKeyRef:
                  key: tls.addr
                  name: devopsbot-settings
            - name: tls.cert
              valueFrom:
                configMapKeyRef:
                  key: tls.cert
                  name: devopsbot-settings
            - name: tls.key
              valueFrom:
                configMapKeyRef:
                  key: tls.key
                  name: devopsbot-settings
            - name: verbose
              valueFrom:
                configMapKeyRef:
                  key: verbose
                  name: devopsbot-settings
            - name: trace
              valueFrom:
                configMapKeyRef:
                  key: trace
                  name: devopsbot-settings
          volumeMounts:
            - name: tls-cert
              mountPath: /var/devopsbot
              readOnly: true
      volumes:
        - name: tls-cert
          secret:
            secretName: &lt;secret_with_tls_cert&gt;
---
</code></pre>
<h2 id="local-development"><a class="header" href="#local-development">Local development</a></h2>
<p>To run the bot locally a valid certificates is needed by using for example <code>mkcert</code>, and <code>devopsbot</code> need to resolve to <code>127.0.0.1</code>:</p>
<pre><code class="language-console">$ mkcert devopsbot
$ sudo echo &quot;127.0.0.1 devopsbot&quot; &gt;&gt; /etc/hosts
</code></pre>
<p>Then, run a local copy after having provided values for parameters
that are empty by default:</p>
<pre><code class="language-console">$ bin/devopsbot \
  --slack.accessToken=xoxb-.... \
  --slack.signingSecret=...
</code></pre>
<p>And access it at <a href="https://devopsbot:3443">https://devopsbot:3443</a> or <a href="http://devopsbot:3333">http://devopsbot:3333</a>.</p>
<p>See the <code>--help</code> output for more flags.</p>
<p>To test <code>devopsbot</code> functionality, it must be accessible by Slack. Optionally
use <a href="https://github.com/inlets/inlets">inlets</a> to expose the locally running
<code>devopsbot</code> to the Internet. The <code>inlets</code> server can run on a free tier EC2
instance. Make sure it is accessible from the whole Internet and port range is
wide enough. Note its publicly accessible IPv4 IP. Run the <code>inlets</code> server from
the EC2 instance. Run the <code>inlets</code> client from laptop where <code>devopsbot</code> is running.</p>
<h3 id="verify-routes"><a class="header" href="#verify-routes">Verify routes</a></h3>
<p>One way of verifying routes is via manual <code>POST</code> requests:</p>
<ol>
<li>Start the bot</li>
<li>Generate a Slack signature for the request body being investigated, in 
this case <code>command=/devopsbot</code>, for example via <code>go</code>:
<pre><code class="language-go">package main

import (
  &quot;crypto/hmac&quot;
  &quot;crypto/sha256&quot;
  &quot;encoding/hex&quot;
  &quot;fmt&quot;
)

func main() {
  h := hmac.New(sha256.New, []byte(&quot;&lt;signing secret, empty if not specified&gt;&quot;))
  _, _ = h.Write([]byte(&quot;v0:&lt;UNIX time stamp&gt;:command=%2Fdevopsbot&quot;))
  computed := h.Sum(nil)
  fmt.Println(hex.EncodeToString(computed))
}
</code></pre>
</li>
<li>Post the request:
<pre><code class="language-sh">curl -X POST -H 'Content-type: application/x-www-form-urlencoded' -H 'X-Slack-Request-Timestamp: &lt;UNIX time stamp&gt;' -H 'X-Slack-Signature: v0=&lt;signature from previous step&gt;' --data 'command=%2Fdevopsbot' localhost:3333/bot/command
</code></pre>
</li>
</ol>
<h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h2>
<p>The bot assumes basic infrastructure to be working.
A mitigation plan should be made if any of these systems fail:</p>
<ul>
<li>The app runs via Slack which can become unavailable, check <a href="https://status.slack.com/">Slack System Status</a></li>
<li>The bot need to be deployed successfully to be available in Slack, check the deployment</li>
<li>The app Docker image is hosted on GitHub container registry which can become unavailable, check <a href="https://www.githubstatus.com/">GitHub Status</a></li>
<li>No internet is available, check with your internet provider</li>
<li>No electricity is available, check with your electricity provider</li>
<li>Input devices work as expected, check keyboard and mouse</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="incident-declaration-automation"><a class="header" href="#incident-declaration-automation">Incident declaration automation</a></h1>
<p>Devopsbot automates incident declaration:</p>
<ul>
<li>Incident responders and commanders should focus on the essential tasks of resolving the incident</li>
<li>Automate the repetitive steps in the incident management process</li>
<li>Keep affected stakeholders informed about the status of the incident</li>
<li>Standardize and document the procedure to lay the foundation for something to be improved upon</li>
</ul>
<p>An incident cannot be planned for, the nature of it is that it just happens.
Incidents happen all the time for everyone, it is an unfortunate but natural part of life.
That does not mean they can be taken for granted. Teams should have a process
for managing them and learn from them.</p>
<p>An incident is defined as something that:</p>
<ul>
<li>Negatively affects customers</li>
<li>Was not planned for</li>
<li>Cannot be resolved within 1 hour</li>
</ul>
<h2 id="during-incidents"><a class="header" href="#during-incidents">During incidents</a></h2>
<p>The workflow during an incident is as follows:</p>
<p><img src="incidents/./devopsbot.drawio.png" alt="incident declaration flow using devopsbot" /></p>
<h2 id="after-incidents"><a class="header" href="#after-incidents">After incidents</a></h2>
<p>When an incident has been declared as resolved, there is a need to communicate the resolution and
learn from the experience.</p>
<p>The workflow after an incident is suggested as follows:</p>
<p><img src="incidents/./after-incident.drawio.png" alt="after" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="slack-app-setup"><a class="header" href="#slack-app-setup">Slack app setup</a></h1>
<p>This page contains the Slack app manifest which can be used to configure the application.
Make sure to set the correct scopes.
Make sure to specify the address <code>bot/command</code> for the slash command.</p>
<pre><code class="language-yaml">_metadata:
  major_version: 1
  minor_version: 1
display_information:
  name: devopsbot
  description: DevOpsBot
  background_color: &quot;#004492&quot;
features:
  bot_user:
    display_name: devopsbot
    always_online: false
  slash_commands:
    - command: /devopsbot
      url: https://&lt;domain&gt;/bot/command
      description: DevOpsBot
      usage_hint: &quot;[help, incident, resolve]&quot;
      should_escape: false
oauth_config:
  scopes:
    user:
      - channels:read
      - channels:write
      - groups:read
      - groups:write
      - im:read
      - im:write
      - mpim:read
      - mpim:write
      - reminders:write
      - users:read
    bot:
      - channels:manage
      - channels:read
      - chat:write
      - chat:write.customize
      - commands
      - groups:read
      - groups:write
      - im:read
      - im:write
      - mpim:read
      - mpim:write
      - users:read
settings:
  interactivity:
    is_enabled: true
    request_url: https://&lt;domain&gt;/bot/interactive
  org_deploy_enabled: false
  socket_mode_enabled: false
  token_rotation_enabled: false
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="localizing-the-bot"><a class="header" href="#localizing-the-bot">Localizing the bot</a></h1>
<p>The locale of the bot is set depending on the user's language preference in Slack.</p>
<p><a href="https://github.com/nicksnyder/go-i18n"><code>go-i18n</code></a> manages the translations.</p>
<p>The web page for <code>go-i18n</code> describes the procedures for translating a new language and new messages, but they are describe here too. First get the tool: <code>go get -u github.com/nicksnyder/go-i18n/v2/goi18n</code>. The binary will be installed into <code>$GOPATH</code>.</p>
<h2 id="translate-a-new-language"><a class="header" href="#translate-a-new-language">Translate a new language</a></h2>
<p>If there is a new language to be added:</p>
<ol>
<li>Create an empty message file for the new language, for example Finnish: <code>touch translate.fi.json</code></li>
<li>Run <code>goi18n merge active.en.json translate.fi.json</code> to populate <code>translate.fi.json</code> with the messages to be translated</li>
<li>Translate <code>translate.fi.json</code> and rename it to <code>active.fi.json</code></li>
<li>Load <code>active.fi.json</code> into the bundle</li>
</ol>
<h2 id="translate-new-messages"><a class="header" href="#translate-new-messages">Translate new messages</a></h2>
<p>If there are new strings to be translated:</p>
<ol>
<li>Run <code>goi18n extract -format json</code> to update <code>active.en.json</code> with new messages</li>
<li>Run <code>goi18n merge active.*.json</code> to generate updated  <code>translate.*.json</code> files</li>
<li>Translate all the messages in the <code>translate.*.json</code> files</li>
<li>Run <code>goi18n merge active.*.json translate.*.json</code> to merge the translated messages into the active message files</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
